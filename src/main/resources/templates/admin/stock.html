<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/admin-fragments :: admin-head('Magazyn')}">
    <title>Magazyn - Panel Administracyjny PetMarket</title>
</head>
<body>

<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrf-token"/>
<input type="hidden" th:value="${_csrf.headerName}" id="csrf-header-name"/>

<div class="admin-layout">
    <aside th:replace="~{fragments/admin-fragments :: sidebar('stock')}"></aside>

    <div class="admin-main">
        <header th:replace="~{fragments/admin-fragments :: admin-topbar}"></header>

        <div class="admin-content">
            <div class="content-header">
                <div>
                    <h1 class="content-title">üì¶ ZarzƒÖdzanie magazynem</h1>
                    <p class="content-subtitle">PrzeglƒÖdaj stan magazynowy i zamawiaj produkty</p>
                </div>
            </div>

            
            <div th:if="${success}" class="alert alert-success">
                <strong>‚úì</strong> <span th:text="${success}">Sukces</span>
            </div>
            <div th:if="${error}" class="alert alert-error">
                <strong>‚úó</strong> <span th:text="${error}">B≈ÇƒÖd</span>
            </div>

            
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #dbeafe; color: #2563eb;">üìä</div>
                    <div class="stat-info">
                        <div class="stat-value" th:text="${totalProducts}">0</div>
                        <div class="stat-label">Wszystkich produkt√≥w</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fef3c7; color: #d97706;">‚ö†Ô∏è</div>
                    <div class="stat-info">
                        <div class="stat-value" th:text="${lowStockCount}">0</div>
                        <div class="stat-label">Niski stan (‚â§10)</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fee2e2; color: #dc2626;">üö´</div>
                    <div class="stat-info">
                        <div class="stat-value" th:text="${outOfStockCount}">0</div>
                        <div class="stat-label">Brak w magazynie</div>
                    </div>
                </div>
            </div>

            
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <a th:href="@{/admin/stock}"
                   th:class="${filter == null ? 'btn btn-primary' : 'btn btn-secondary'}">
                    Wszystkie
                </a>
                <a th:href="@{/admin/stock(filter='low')}"
                   th:class="${filter == 'low' ? 'btn btn-primary' : 'btn btn-secondary'}">
                    ‚ö†Ô∏è Niski stan
                </a>
                <a th:href="@{/admin/stock(filter='out')}"
                   th:class="${filter == 'out' ? 'btn btn-primary' : 'btn btn-secondary'}">
                    üö´ Brak w magazynie
                </a>
            </div>

            
            <div class="card">
                <div class="card-body" style="overflow-x: auto;">
                    <table class="data-table" style="width: 100%;">
                        <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>SKU</th>
                            <th>Cena</th>
                            <th>Stan magazynowy</th>
                            <th>Status</th>
                            <th>Zam√≥wienie</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="product : ${products.content}" th:id="'product-row-' + ${product.id}">
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 50px; height: 50px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                        <img th:if="${product.mainImageUrl != null and (product.mainImageUrl.startsWith('/') or product.mainImageUrl.startsWith('http'))}"
                                             th:src="${product.mainImageUrl}"
                                             style="max-width: 100%; max-height: 100%; object-fit: cover;">
                                        <span th:unless="${product.mainImageUrl != null and (product.mainImageUrl.startsWith('/') or product.mainImageUrl.startsWith('http'))}"
                                              style="font-size: 24px;" th:text="${product.mainImageUrl != null ? product.mainImageUrl : 'üì¶'}">üì¶</span>
                                    </div>
                                    <div>
                                        <strong th:text="${product.name}">Nazwa produktu</strong>
                                        <div style="font-size: 12px; color: #666;" th:text="${product.category?.name}">Kategoria</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span th:text="${product.sku ?: '-'}" style="font-family: monospace;">SKU</span>
                            </td>
                            <td>
                                <span th:text="${#numbers.formatDecimal(product.price, 1, 2)} + ' z≈Ç'">0.00 z≈Ç</span>
                            </td>
                            <td>
                                <span th:id="'stock-display-' + ${product.id}"
                                      style="font-weight: bold; font-size: 16px;"
                                      th:class="${product.stockQuantity == 0 ? 'stock-empty-text' : (product.stockQuantity <= 10 ? 'stock-low-text' : '')}"
                                      th:text="${product.stockQuantity}">0</span>
                                <span style="color: #666; font-size: 12px;"> szt.</span>
                            </td>
                            <td>
                                <span th:id="'status-badge-' + ${product.id}"
                                      th:class="'status-badge status-' + ${#strings.toLowerCase(product.status.name())}"
                                      th:text="${product.status.name() == 'ACTIVE' ? 'Aktywny' :
                                                (product.status.name() == 'INACTIVE' ? 'Nieaktywny' :
                                                (product.status.name() == 'SOLDOUT' ? 'Wyprzedany' :
                                                (product.status.name() == 'DRAFT' ? 'Szkic' : product.status.name())))}">
                                    Status
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" min="1" value="10"
                                           th:id="'order-qty-' + ${product.id}"
                                           style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center;"
                                           placeholder="Ilo≈õƒá">
                                    <button type="button" class="btn btn-sm btn-success"
                                            th:onclick="'orderStock(' + ${product.id} + ')'"
                                            title="Zam√≥w wiƒôcej produkt√≥w">
                                        üì• Zam√≥w
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${products.content.isEmpty()}">
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                                <p>Brak produkt√≥w do wy≈õwietlenia</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            
            <div th:if="${totalPages > 1}" class="pagination" style="margin-top: 20px;">
                <a th:if="${currentPage > 0}"
                   th:href="@{/admin/stock(page=${currentPage - 1}, filter=${filter})}"
                   class="pagination-btn">‚Üê Poprzednia</a>
                <span class="pagination-info">
                    Strona <span th:text="${currentPage + 1}">1</span> z <span th:text="${totalPages}">1</span>
                </span>
                <a th:if="${currentPage < totalPages - 1}"
                   th:href="@{/admin/stock(page=${currentPage + 1}, filter=${filter})}"
                   class="pagination-btn">Nastƒôpna ‚Üí</a>
            </div>
        </div>
    </div>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
    }

    .stat-label {
        font-size: 14px;
        color: #666;
    }

    .stock-empty-text {
        color: #dc2626;
    }

    .stock-low-text {
        color: #d97706;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-active {
        background: #dcfce7;
        color: #16a34a;
    }

    .status-inactive {
        background: #f3f4f6;
        color: #666;
    }

    .status-soldout {
        background: #fee2e2;
        color: #dc2626;
    }

    .status-draft {
        background: #e0e7ff;
        color: #4f46e5;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background: #1d4ed8;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-success {
        background: #16a34a;
        color: white;
    }

    .btn-success:hover {
        background: #15803d;
    }

    .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .btn-warning:hover {
        background: #d97706;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .data-table {
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .data-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .data-table tr:hover {
        background: #f9fafb;
    }

    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-success {
        background: #dcfce7;
        color: #16a34a;
        border: 1px solid #bbf7d0;
    }

    .alert-error {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }

    .pagination-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        text-decoration: none;
        color: #374151;
    }

    .pagination-btn:hover {
        background: #f3f4f6;
    }
</style>

<script>
    // Get CSRF token from hidden inputs
    const csrfTokenInput = document.getElementById('csrf-token');
    const csrfHeaderInput = document.getElementById('csrf-header-name');
    const csrfToken = csrfTokenInput?.value;
    const csrfHeader = csrfHeaderInput?.value;

    function orderStock(productId) {
        const input = document.getElementById('order-qty-' + productId);
        const quantity = parseInt(input.value);

        if (isNaN(quantity) || quantity <= 0) {
            showToast('Proszƒô podaƒá prawid≈ÇowƒÖ ilo≈õƒá (>0)', 'error');
            return;
        }

        const headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
        };

        // Add CSRF token to headers if available
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        fetch('/admin/stock/' + productId + '/increase', {
            method: 'POST',
            headers: headers,
            body: 'quantity=' + quantity
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the displayed stock quantity
                    const stockDisplay = document.getElementById('stock-display-' + productId);
                    if (stockDisplay) {
                        stockDisplay.textContent = data.newStock;
                        // Update styling based on new stock
                        stockDisplay.classList.remove('stock-empty-text', 'stock-low-text');
                        if (data.newStock === 0) {
                            stockDisplay.classList.add('stock-empty-text');
                        } else if (data.newStock <= 10) {
                            stockDisplay.classList.add('stock-low-text');
                        }
                    }
                    updateStatusBadge(productId, data.status);
                    showToast('Zam√≥wiono ' + quantity + ' szt. Nowy stan: ' + data.newStock, 'success');
                    input.value = 10; // Reset to default
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas zamawiania', 'error');
            });
    }

    function updateStatusBadge(productId, status) {
        const badge = document.getElementById('status-badge-' + productId);
        if (badge) {
            badge.className = 'status-badge status-' + status.toLowerCase();
            const statusTexts = {
                'ACTIVE': 'Aktywny',
                'INACTIVE': 'Nieaktywny',
                'SOLDOUT': 'Wyprzedany',
                'DRAFT': 'Szkic'
            };
            badge.textContent = statusTexts[status] || status;
        }
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#16a34a' : '#dc2626'};
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    // Add animation keyframes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
</script>

</body>
</html>