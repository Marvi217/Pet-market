<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="${category.name} + ' - PetMarket'">Kategoria - PetMarket</title>
    <link rel="stylesheet" href="/css/public-styles.css">
</head>
<body>
<div th:replace="~{fragments/header :: navbar}"></div>
<div th:replace="~{fragments/header :: categoryBar}"></div>

<div class="breadcrumb">
    <a th:href="@{/}" th:text="#{breadcrumb.home}">Strona g≈Ç√≥wna</a> /
    <span th:text="${category.name}">Kategoria</span>
</div>

<div class="container">
    <div class="category-header">
        <div>
            <h1 class="category-title" th:text="${category.name}">Subkategoria</h1>
            <p class="category-count">
                <span th:text="${totalProducts}">0</span>
                <span th:text="#{category.products}">produkt√≥w</span>
            </p>
        </div>
    </div>

    <div class="category-layout">

        <aside class="sidebar">
            <div id="filterContainer">

                <button type="button" class="mobile-filter-close" onclick="toggleFilters()">‚úï</button>

                <div class="filter-section" th:if="${subCategories != null and !subCategories.isEmpty()}">
                    <h3 class="filter-title" th:text="#{category.filter.subcategories}">Subkategorie</h3>
                    <div class="filter-group" id="subcategoryFilters">
                        <th:block th:each="sub, stat : ${subCategories}">
                            <label class="filter-option" th:if="${sub.productCount > 0}">
                                <input type="checkbox" name="subcategory" th:value="${sub.id}"
                                       th:checked="${selectedSubcategories.contains(sub.id)}"
                                       onchange="applyFiltersAsync()">
                                <span th:text="${sub.name}">Subkategoria</span>
                                <span class="filter-count" th:text="'(' + ${sub.productCount} + ')'"></span>
                            </label>
                        </th:block>
                    </div>
                </div>

                <div class="filter-section" th:if="${brandFilters != null and !brandFilters.isEmpty()}">
                    <h3 class="filter-title" th:text="#{category.filter.brand}">Marki</h3>
                    <div class="filter-group" id="brandFilters">
                        <th:block th:each="brand, stat : ${brandFilters}">
                            <label class="filter-option" th:if="${brand.count > 0}"
                                   th:classappend="${stat.index >= 5} ? 'brand-hidden'">
                                <input type="checkbox" name="brands" th:value="${brand.id}"
                                       th:checked="${selectedBrands.contains(brand.id)}"
                                       onchange="applyFiltersAsync()">
                                <span th:text="${brand.name}">Marka</span>
                                <span class="filter-count" th:text="'(' + ${brand.count} + ')'"></span>
                            </label>
                        </th:block>
                    </div>
                    <button type="button" class="btn-expand-filters" id="expandBrandsBtn"
                            onclick="toggleBrandsList()" th:text="#{category.filter.expand}">Rozwi≈Ñ</button>
                </div>

                <div class="filter-section">
                    <h3 class="filter-title" th:text="#{category.filter.price}">Cena</h3>
                    <div class="price-inputs">
                        <input type="number" id="minPriceInput" th:placeholder="#{category.filter.price.min}"
                               th:value="${currentMinPrice}" min="0" step="1">
                        <span>-</span>
                        <input type="number" id="maxPriceInput" th:placeholder="#{category.filter.price.max}"
                               th:value="${currentMaxPrice}" min="0" step="1">
                        <span th:text="#{general.currency}">z≈Ç</span>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="button" class="btn-apply-filters" onclick="applyFiltersAsync()" th:text="#{category.filter.apply}">Zastosuj filtry</button>
                    <a th:href="@{/category/{slug}(slug=${category.slug})}" class="btn-clear-filters" th:text="#{category.filter.clear}">Wyczy≈õƒá</a>
                </div>
            </div>
        </aside>

        <div class="products-section">

            <div class="sorting-bar">
                <div class="sorting-info">
                    <span th:text="#{category.showing}">Wy≈õwietlanie</span>
                    <strong th:text="${totalProducts}">0</strong>
                    <span th:text="#{category.products}">produkt√≥w</span>
                </div>
                <div class="sort-controls">
                    <label th:text="#{category.sort}">Sortuj:</label>
                    <select id="sortSelect" onchange="updateSort(this.value)">
                        <option value="default" th:selected="${currentSort == 'default' or currentSort == null}"
                                th:text="#{category.sort.default}">Domy≈õlnie</option>
                        <option value="price-asc" th:selected="${currentSort == 'price-asc'}"
                                th:text="#{category.sort.price.asc}">Cena: rosnƒÖco</option>
                        <option value="price-desc" th:selected="${currentSort == 'price-desc'}"
                                th:text="#{category.sort.price.desc}">Cena: malejƒÖco</option>
                        <option value="name-asc" th:selected="${currentSort == 'name-asc'}"
                                th:text="#{category.sort.name.asc}">Nazwa: A-Z</option>
                        <option value="name-desc" th:selected="${currentSort == 'name-desc'}"
                                th:text="#{category.sort.name.desc}">Nazwa: Z-A</option>
                        <option value="rating" th:selected="${currentSort == 'rating'}"
                                th:text="#{category.sort.rating}">Ocena</option>
                    </select>
                </div>
            </div>

            <div class="active-filters" th:if="${!activeFilters.isEmpty()}">
                <span th:each="filter : ${activeFilters}" class="filter-tag">
                    <span th:text="${filter.label}">Filtr</span>
                </span>
            </div>

            <div th:if="${!products.isEmpty()}" class="products-grid">
                <a th:each="product : ${products}"
                   th:href="@{/product/{id}(id=${product.id})}"
                   class="product-card">

                    <div th:if="${product.hasDiscount and !product.buyXGetYPromotion and product.discountPercent > 0}" class="product-badge"
                         th:text="'-' + ${product.discountPercent} + '%'">-25%</div>
                    <div th:if="${product.buyXGetYPromotion}" class="product-badge"
                         th:text="'%'">%</div>

                    <button type="button"
                            sec:authorize="isAuthenticated()"
                            class="wishlist-btn"
                            th:classappend="${wishlistProductIds.contains(product.id)} ? 'active' : ''"
                            th:data-product-id="${product.id}"
                            onclick="toggleWishlist(this, event)"
                            th:title="${wishlistProductIds.contains(product.id)} ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych'">
                        <span class="heart" th:text="${wishlistProductIds.contains(product.id)} ? '‚ô•' : '‚ô°'">‚ô°</span>
                    </button>

                    <div class="product-image">
                        <img th:if="${product.mainImageUrl != null and (product.mainImageUrl.startsWith('/') or product.mainImageUrl.startsWith('http'))}"
                             th:src="${product.mainImageUrl}" th:alt="${product.name}"
                             style="max-width: 100%; max-height: 180px; object-fit: contain;">
                        <span th:unless="${product.mainImageUrl != null and (product.mainImageUrl.startsWith('/') or product.mainImageUrl.startsWith('http'))}"
                              style="font-size: 64px;" th:text="${product.mainImageUrl != null ? product.mainImageUrl : 'ü¶¥'}">ü¶¥</span>
                    </div>

                    <div class="product-info">
                        <h3 class="product-name" th:text="${product.name}">Nazwa produktu</h3>

                        <p class="product-desc" th:text="${product.shortDescription}">Opis produktu</p>

                        <div class="product-footer">
                            <div class="product-pricing">
                                <span class="old-price" th:if="${product.hasDiscount and !product.buyXGetYPromotion}"
                                      th:text="${#numbers.formatDecimal(product.oldPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                                <span class="product-price"
                                      th:text="${#numbers.formatDecimal(product.currentPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                            </div>

                            <button type="button"
                                    th:if="${product.available}"
                                    class="btn-add-cart"
                                    th:data-product-id="${product.id}"
                                    onclick="addToCartAsync(this, event)"
                                    title="Do koszyka">
                                üõí
                            </button>
                            <span th:unless="${product.available}"
                                  class="sold-out-badge"
                                  style="background: #fee2e2; color: #dc2626; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;"
                                  th:text="${product.unavailableMessage}">
                                Produkt niedostƒôpny
                            </span>
                        </div>
                    </div>
                </a>
            </div>

            <div th:if="${products.isEmpty()}" class="empty-state">
                <div class="empty-icon">üì¶</div>
                <h2 class="empty-title" th:text="#{search.no.results}">Brak wynik√≥w</h2>
                <p class="empty-text">Spr√≥buj zmieniƒá filtry lub wr√≥ƒá do strony g≈Ç√≥wnej</p>
                <a th:href="@{/}" class="btn-primary" th:text="#{breadcrumb.home}">Strona g≈Ç√≥wna</a>
            </div>

            <div class="pagination" th:if="${productPage.totalPages > 1}">
                <a th:if="${productPage.number > 0}"
                   th:data-page="${productPage.number - 1}"
                   onclick="goToPage(this.getAttribute('data-page'))"
                   class="pagination-btn" style="cursor: pointer;">‚Üê Poprzednia</a>
                <span class="pagination-info">
                    <span th:text="${productPage.number + 1}">1</span> / <span th:text="${productPage.totalPages}">1</span>
                </span>
                <a th:if="${productPage.number < productPage.totalPages - 1}"
                   th:data-page="${productPage.number + 1}"
                   onclick="goToPage(this.getAttribute('data-page'))"
                   class="pagination-btn" style="cursor: pointer;">Nastƒôpna ‚Üí</a>
            </div>
        </div>
    </div>
</div>

<button class="mobile-filter-btn" onclick="toggleFilters()" th:text="#{category.filter.show}">üîç Filtry</button>

<footer>
    <p th:text="#{footer.copyright}">&copy; 2026 PetMarket - Wszystkie prawa zastrze≈ºone</p>
</footer>

<script th:inline="javascript">
    const categorySlug = /*[[${category.slug}]]*/ '';
    let brandsExpanded = false;

    document.addEventListener('DOMContentLoaded', function() {
        const hiddenBrands = document.querySelectorAll('.brand-hidden');
        const expandBtn = document.getElementById('expandBrandsBtn');
        if (hiddenBrands.length === 0 && expandBtn) {
            expandBtn.style.display = 'none';
        }
    });

    function toggleBrandsList() {
        const hiddenBrands = document.querySelectorAll('.brand-hidden');
        const expandBtn = document.getElementById('expandBrandsBtn');
        brandsExpanded = !brandsExpanded;

        hiddenBrands.forEach(brand => {
            brand.style.display = brandsExpanded ? 'flex' : 'none';
        });

        expandBtn.textContent = brandsExpanded ? 'Zwi≈Ñ' : 'Rozwi≈Ñ';
    }

    function applyFiltersAsync() {
        const subcategoryCheckboxes = document.querySelectorAll('#subcategoryFilters input[type="checkbox"]:checked');
        const subcategories = Array.from(subcategoryCheckboxes).map(cb => cb.value);

        const brandCheckboxes = document.querySelectorAll('#brandFilters input[type="checkbox"]:checked');
        const brands = Array.from(brandCheckboxes).map(cb => cb.value);

        const minPrice = document.getElementById('minPriceInput')?.value;
        const maxPrice = document.getElementById('maxPriceInput')?.value;

        const sortSelect = document.getElementById('sortSelect');
        const sort = sortSelect ? sortSelect.value : 'default';

        const url = new URL(window.location.origin + '/category/' + categorySlug);

        subcategories.forEach(id => url.searchParams.append('subcategory', id));
        brands.forEach(id => url.searchParams.append('brands', id));
        if (minPrice) url.searchParams.set('minPrice', minPrice);
        if (maxPrice) url.searchParams.set('maxPrice', maxPrice);
        url.searchParams.set('sort', sort);

        window.location.href = url.toString();
    }

    function updateSort(sortValue) {
        applyFiltersAsync();
    }

    function goToPage(pageNum) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', pageNum);
        window.location.href = url.toString();
    }

    function toggleFilters() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('mobile-open');
    }

    async function updateFilterCounts() {
        const subcategoryCheckboxes = document.querySelectorAll('#subcategoryFilters input[type="checkbox"]:checked');
        const subcategories = Array.from(subcategoryCheckboxes).map(cb => cb.value);

        const brandCheckboxes = document.querySelectorAll('#brandFilters input[type="checkbox"]:checked');
        const brands = Array.from(brandCheckboxes).map(cb => cb.value);

        const minPrice = document.getElementById('minPriceInput')?.value;
        const maxPrice = document.getElementById('maxPriceInput')?.value;

        const url = new URL(window.location.origin + '/category/' + categorySlug + '/filter-counts');
        subcategories.forEach(id => url.searchParams.append('subcategory', id));
        brands.forEach(id => url.searchParams.append('brands', id));
        if (minPrice) url.searchParams.set('minPrice', minPrice);
        if (maxPrice) url.searchParams.set('maxPrice', maxPrice);

        try {
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();

                if (data.brandCounts) {
                    const brandCountMap = {};
                    data.brandCounts.forEach(b => brandCountMap[b.id] = b.count);

                    document.querySelectorAll('#brandFilters .filter-option').forEach(label => {
                        const input = label.querySelector('input');
                        const countSpan = label.querySelector('.filter-count');
                        if (input && countSpan) {
                            const brandId = input.value;
                            const count = brandCountMap[brandId] || 0;
                            countSpan.textContent = '(' + count + ')';
                        }
                    });
                }

                if (data.subcategoryCounts) {
                    const subCountMap = {};
                    data.subcategoryCounts.forEach(s => subCountMap[s.id] = s.productCount);

                    document.querySelectorAll('#subcategoryFilters .filter-option').forEach(label => {
                        const input = label.querySelector('input');
                        const countSpan = label.querySelector('.filter-count');
                        if (input && countSpan) {
                            const subId = input.value;
                            const count = subCountMap[subId] || 0;
                            countSpan.textContent = '(' + count + ')';
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Error fetching filter counts:', error);
        }
    }

    document.getElementById('minPriceInput')?.addEventListener('input', debounce(updateFilterCounts, 500));
    document.getElementById('maxPriceInput')?.addEventListener('input', debounce(updateFilterCounts, 500));

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async function addToCartAsync(button, event) {
        event.preventDefault();
        event.stopPropagation();

        const productId = button.getAttribute('data-product-id');
        const originalContent = button.innerHTML;

        button.disabled = true;
        button.innerHTML = '‚è≥';

        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            const formData = new FormData();
            formData.append('productId', productId);
            formData.append('quantity', 1);

            const headers = {};
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            const response = await fetch('/cart/add-async', {
                method: 'POST',
                headers: headers,
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                button.innerHTML = '‚úì';
                button.style.background = '#16a34a';

                const cartBadge = document.getElementById('cart-badge-count');
                if (cartBadge && data.totalItems !== undefined) {
                    cartBadge.textContent = data.totalItems;
                    cartBadge.style.display = data.totalItems > 0 ? 'flex' : 'none';
                }

                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.background = '';
                    button.disabled = false;
                }, 1500);
            } else {
                const errorText = await response.text();
                alert(errorText || 'Nie uda≈Ço siƒô dodaƒá produktu do koszyka');
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania do koszyka');
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    }

    async function toggleWishlist(button, event) {
        event.preventDefault();
        event.stopPropagation();

        const productId = button.getAttribute('data-product-id');
        const heartSpan = button.querySelector('.heart');

        button.disabled = true;

        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            const headers = {
                'Content-Type': 'application/json'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            const response = await fetch('/wishlist/toggle', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ productId: parseInt(productId) })
            });

            const data = await response.json();

            if (data.success) {
                if (data.added) {
                    button.classList.add('active');
                    heartSpan.textContent = '‚ô•';
                    button.title = 'Usu≈Ñ z ulubionych';
                } else {
                    button.classList.remove('active');
                    heartSpan.textContent = '‚ô°';
                    button.title = 'Dodaj do ulubionych';
                }
            } else if (data.requireLogin) {
                window.location.href = '/login?returnUrl=' + encodeURIComponent(window.location.pathname);
            } else {
                console.error('Wishlist error:', data.message);
            }
        } catch (error) {
            console.error('Error toggling wishlist:', error);
        } finally {
            button.disabled = false;
        }
    }
</script>

</body>
</html>